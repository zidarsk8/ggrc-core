#!/usr/bin/env bash
# Copyright (C) 2017 Google Inc.
# Licensed under http://www.apache.org/licenses/LICENSE-2.0 <see LICENSE file>

set -o errexit
set -o nounset

if [[ -z "${1:-}" ]] || [[ -z "${2:-}" ]] || [[ -z "${3:-}" ]]
then
  echo "Usage `basename ${0}` <settings_file> <service-account> <key-file>"
  exit
fi

SETTINGS_FILE="$1"
ACCOUNT="$2"
KEY_FILE="$3"

ENV_OVERRIDE_FILE=${ENV_OVERRIDE_FILE:-"override.sh"}
VERSION="1"


write_visible_message () {
  message=${1:-}
  echo '-----'
  echo ${message}
  echo '-----'
}


set +o nounset  # this file is autogenerated thus we don't fix its unset vars
source /vagrant/bin/init_vagrant_env
set -o nounset

write_visible_message 'Setting build hash into version info'
./git_hooks/post-checkout

write_visible_message 'Generating app.yaml'
deploy_appengine "$SETTINGS_FILE"
cat /vagrant/src/app.yaml

source "$SETTINGS_FILE"
source "$ENV_OVERRIDE_FILE"
export GGRC_SETTINGS_MODULE="$SETTINGS_MODULE"

db_migrate

write_visible_message 'Setting project into config'
gcloud config set project "$APPENGINE_INSTANCE"

write_visible_message 'Authenticating'
gcloud auth activate-service-account "$ACCOUNT" --key-file="$KEY_FILE"

write_visible_message "Deploying src/app.yaml into version $VERSION"
gcloud app deploy src/app.yaml --version="$VERSION"
